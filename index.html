<!DOCTYPE html>
<html>
<head>
  <title>Live Fire Map (Polygons & Shapes)</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <style>
    body { margin: 0; padding: 0; font-family: sans-serif; }
    #map { height: 100vh; width: 100%; }
    .legend { background: white; padding: 10px; border-radius: 5px; box-shadow: 0 0 15px rgba(0,0,0,0.2); font-size: 12px; }
    .legend i { width: 15px; height: 15px; float: left; margin-right: 8px; opacity: 0.8; }
    .update-time { position: absolute; top: 10px; right: 10px; background: white; padding: 5px 10px; border-radius: 4px; z-index: 1000; font-size: 12px; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
  </style>
</head>
<body>

<div id="map"></div>
<div class="update-time" id="last-updated">Loading...</div>

<script>
  // --- SETTINGS ---
  // We now read from the files the Robot saved in the SAME folder
  // Add a timestamp to bypass browser caching
  var nswUrl = "./nsw_data.json?t=" + new Date().getTime();
  var vicUrl = "./vic_data.json?t=" + new Date().getTime();

  // --- MAP SETUP ---
  var map = L.map('map').setView([-36.0, 147.0], 6);
  
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap &copy; CARTO',
    subdomains: 'abcd',
    maxZoom: 19
  }).addTo(map);

  var nswLayer = L.layerGroup().addTo(map);
  var vicLayer = L.layerGroup().addTo(map);

  // --- STYLING ---
  var colors = {
    "Emergency Warning": "#d92b2b", // Red
    "Watch and Act": "#e67e22",     // Orange
    "Advice": "#f1c40f",            // Yellow
    "Under Control": "#2ecc71"      // Green
  };

  function getAlertLevel(props, source) {
    var cat = "Advice";
    if (source === "VIC") {
      var c = (props.category1 || "") + (props.category2 || "");
      if (c.includes("Emergency")) cat = "Emergency Warning";
      else if (c.includes("Watch and Act")) cat = "Watch and Act";
    } else {
      var c = props.category || "";
      if (c.toLowerCase().includes("emergency")) cat = "Emergency Warning";
      else if (c.toLowerCase().includes("watch and act")) cat = "Watch and Act";
    }
    return cat;
  }

  // Style for Polygons
  function styleFeature(feature) {
    var level = feature.properties.alertLevel || "Advice";
    return {
      fillColor: colors[level],
      weight: 2,
      opacity: 1,
      color: colors[level], // Outline same color as fill
      fillOpacity: 0.5
    };
  }

  // Style for Dots (Points)
  function pointStyle(feature, latlng) {
    var level = feature.properties.alertLevel || "Advice";
    return L.circleMarker(latlng, {
      radius: 6,
      fillColor: colors[level],
      color: "#fff",
      weight: 1,
      opacity: 1,
      fillOpacity: 1
    });
  }

  function onEachFeature(feature, layer) {
    var p = feature.properties;
    var popupContent = "<h3>" + (p.title || p.location || "Unknown") + "</h3>";
    popupContent += "<b>Level:</b> " + p.alertLevel + "<br>";
    popupContent += "<b>Status:</b> " + (p.status || "Going") + "<br>";
    popupContent += "<b>Size:</b> " + (p.size || p.sizeFmt || "N/A");
    layer.bindPopup(popupContent);
  }

  // --- DATA LOADING ---
  function loadData() {
    var now = new Date();
    document.getElementById("last-updated").innerHTML = "Updated: " + now.toLocaleTimeString();

    // 1. NSW
    fetch(nswUrl)
      .then(r => r.json())
      .then(data => {
        nswLayer.clearLayers();
        var cleanData = { type: "FeatureCollection", features: [] };
        
        data.features.forEach(f => {
          var p = f.properties;
          if (p.category == "Not Applicable" || p.category == "Under Control") return;
          p.alertLevel = getAlertLevel(p, "NSW");
          p.title = p.title.replace(/^(Bush Fire|Grass Fire|Structure Fire|Burn off) - /, "");
          cleanData.features.push(f);
        });

        // Leaflet automatically handles GeometryCollection (Points + Polygons)
        L.geoJSON(cleanData, {
          style: styleFeature,
          onEachFeature: onEachFeature,
          pointToLayer: pointStyle
        }).addTo(nswLayer);
      });

    // 2. VIC
    fetch(vicUrl)
      .then(r => r.json())
      .then(data => {
        vicLayer.clearLayers();
        var cleanData = { type: "FeatureCollection", features: [] };
        
        data.features.forEach(f => {
          var p = f.properties;
          if ((p.category1 !== "Fire" && p.category2 !== "Fire") || p.status === "False Alarm") return;
          if (p.category2 === "Total Fire Ban") return;

          p.alertLevel = getAlertLevel(p, "VIC");
          var status = p.status || "Going";
          
          // Strict Filter: Hide 'Safe' fires unless they are Warnings
          if ((status === "Under Control" || status === "Safe") && p.alertLevel === "Advice") return;

          cleanData.features.push(f);
        });

        L.geoJSON(cleanData, {
          style: styleFeature,
          onEachFeature: onEachFeature,
          pointToLayer: pointStyle
        }).addTo(vicLayer);
      });
  }

  // Run immediately
  loadData();
  
  // Refresh map view every 60s (reads the files again)
  setInterval(loadData, 60000);

  // Legend
  var legend = L.control({position: 'bottomright'});
  legend.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'legend');
    div.innerHTML += "<b>Fire Warning</b><br>";
    div.innerHTML += '<i style="background: #d92b2b"></i> Emergency<br>';
    div.innerHTML += '<i style="background: #e67e22"></i> Watch & Act<br>';
    div.innerHTML += '<i style="background: #f1c40f"></i> Advice<br>';
    return div;
  };
  legend.addTo(map);

</script>
</body>
</html>
